{% extends 'trading/base.html' %}

{% block title %}Orderbook Dashboard - NeoTrade{% endblock %}

{% block content %}
<style>
  .container {
    max-width: 1400px;
    margin: 0 auto;
    animation: fadeIn 0.8s ease-in-out;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .dashboard-title {
    text-align: center;
    margin-bottom: 32px;
    color: var(--accent);
    font-size: 2.2rem;
  }
  .card {
    background: var(--panel);
    border: 1px solid var(--panel-border);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .card:hover {
    transform: translateY(-4px);
    box-shadow: 0px 14px 26px rgba(0, 0, 0, 0.2);
  }
  .card h4 {
    color: var(--accent);
    margin-bottom: 10px;
  }
  .table-responsive {
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(10, 14, 20, 0.5);
    border-radius: 10px;
    margin-bottom: 20px;
  }
  table th, table td {
    padding: 12px 15px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.06);
  }
  table th {
    background: rgba(10, 14, 20, 0.7);
    color: var(--accent);
  }
  table tbody tr:hover {
    background: rgba(94, 242, 194, 0.08);
  }
  h3 {
    color: var(--accent);
    margin: 20px 0;
    text-align: center;
  }
  .row {
    display: flex;
    flex-wrap: wrap;
    margin: 0 -10px;
  }
  .col {
    flex: 1;
    padding: 0 10px;
    min-width: 300px;
  }
  .table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }
  .table-header button {
    padding: 6px 12px;
    background-color: #1a3a4a;
    border: 1px solid rgba(94, 242, 194, 0.4);
    color: var(--text);
    font-size: 14px;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s ease-in-out;
  }
  .table-header button:hover {
    background-color: rgba(94, 242, 194, 0.2);
  }
</style>

<div class="container">
  <h2 class="dashboard-title">Orderbook Dashboard</h2>

  <div class="row">
    <div class="col">
      <div class="card">
        <h4>Best Bid</h4>
        <p id="best-bid">Waiting for update...</p>
      </div>
    </div>
    <div class="col">
      <div class="card">
        <h4>Best Ask</h4>
        <p id="best-ask">Waiting for update...</p>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <div class="table-responsive">
        <table id="buy-orders">
          <div class="table-header">
            <h3>Buy Orders</h3>
            <button onclick="downloadBuyOrdersCSV()">Download CSV</button>
          </div>
          <thead>
            <tr><th>Price</th><th>Quantity</th></tr>
          </thead>
          <tbody><tr><td colspan="2">Waiting for update...</td></tr></tbody>
        </table>
      </div>
    </div>
    <div class="col">
      <div class="table-header">
        <h3>Sell Orders</h3>
        <button onclick="downloadSellOrdersCSV()">Download CSV</button>
      </div>
      <div class="table-responsive">
        <table id="sell-orders">
          <thead>
            <tr><th>Price</th><th>Quantity</th></tr>
          </thead>
          <tbody><tr><td colspan="2">Waiting for update...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="order-modal" style="
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    align-items: center; justify-content: center;
  ">
    <div style="
      background: #111;
      padding: 1rem;
      border-radius: 8px;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
      color: #fff;
    ">
      <button id="modal-close" style="
        float: right;
        background: none;
        border: none;
        color: #aaa;
        font-size: 1.5rem;
        cursor: pointer;
      ">&times;</button>
      <h4>Order Details at <span id="modal-price"></span></h4>
      <table id="modal-table" style="width:100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th>User</th>
            <th>Quantity</th>
            <th>Disclosed</th>
            <th>Original_quantity</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="row">
    <div class="col" style="flex: 100%;">
      <div class="table-header">
        <h3>Recent Trades</h3>
        <button onclick="downloadTradesCSV()">Download CSV</button>
      </div>
      <div class="table-responsive">
        <table id="trades">
          <thead>
            <tr>
              <th>Buyer</th><th>Seller</th><th>Price</th><th>Quantity</th><th>Timestamp</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="5">Waiting for update...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function updateBestBid() {
    fetch('/orderbook/get_best_bid/')
      .then(response => response.json())
      .then(data => {
        const bestBidContainer = document.querySelector('#best-bid');
        if (data.best_bid && data.best_bid.price !== null) {
          bestBidContainer.innerHTML = `Price: ${data.best_bid.price} | Quantity: ${data.best_bid.disclosed}`;
        } else {
          bestBidContainer.innerHTML = 'No bids available';
        }
      })
      .catch(error => console.error('Error fetching Best Bid:', error));
  }

  function updateBestAsk() {
    fetch('/orderbook/get_best_ask/')
      .then(response => response.json())
      .then(data => {
        const bestAskContainer = document.querySelector('#best-ask');
        if (data.best_ask && data.best_ask.price !== null) {
          bestAskContainer.innerHTML = `Price: ${data.best_ask.price} | Quantity: ${data.best_ask.disclosed}`;
        } else {
          bestAskContainer.innerHTML = 'No asks available';
        }
      })
      .catch(error => console.error('Error fetching Best Ask:', error));
  }

  function downloadBuyOrdersCSV() {
    fetch('/orderbook/get_buy_orders/')
      .then(response => response.json())
      .then(data => {
        const buyOrders = data.buy_orders;
        const headers = ["price", "quantity", "disclosed", "user", "original_quantity"];
        const rows = buyOrders.map(order => headers.map(h => {
          let val = order[h];
          return `"${(val ?? "").toString().replace(/"/g, '""')}"`;
        }).join(','));

        const csv = [headers.join(','), ...rows].join('\r\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'buy_orders.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      })
      .catch(err => console.error('Error generating CSV:', err));
  }

  function downloadSellOrdersCSV() {
    fetch('/orderbook/get_sell_orders/')
      .then(response => response.json())
      .then(data => {
        const sellOrders = data.sell_orders;
        const headers = ["price", "quantity", "disclosed", "user", "original_quantity"];
        const rows = sellOrders.map(order => headers.map(h => {
          let val = order[h];
          return `"${(val ?? "").toString().replace(/"/g, '""')}"`;
        }).join(','));

        const csv = [headers.join(','), ...rows].join('\r\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'sell_orders.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      })
      .catch(err => console.error('Error generating CSV:', err));
  }

  function downloadTradesCSV() {
    fetch('/orderbook/get_recent_trades/')
      .then(response => response.json())
      .then(data => {
        const trades = data.trades;
        const headers = ["buyer", "seller", "price", "quantity", "timestamp"];
        const rows = trades.map(trade => headers.map(h => {
          let val = trade[h];
          return `"${(val ?? "").toString().replace(/"/g, '""')}"`;
        }).join(','));

        const csv = [headers.join(','), ...rows].join('\r\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'trades.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      })
      .catch(err => console.error('Error generating CSV:', err));
  }

  let buyOrdersByPrice = {};

  function updateBuyOrders() {
    fetch('/orderbook/get_buy_orders/')
      .then(r => r.json())
      .then(data => {
        const tbody = document.querySelector('#buy-orders tbody');
        tbody.innerHTML = '';
        buyOrdersByPrice = {};

        const grouped = {};
        data.buy_orders
          .filter(o => !o.is_ioc)
          .forEach(o => {
            const price = parseFloat(o.price).toFixed(2);
            const qty   = parseFloat(o.quantity)  || 0;
            const disc  = parseFloat(o.disclosed) || 0;

            if (!grouped[price]) grouped[price] = { quantity: 0, disclosed: 0 };
            grouped[price].quantity  += qty;
            grouped[price].disclosed += disc;

            if (!buyOrdersByPrice[price]) buyOrdersByPrice[price] = [];
            buyOrdersByPrice[price].push(o);
          });

        Object.entries(grouped)
          .sort((a,b) => parseFloat(b[0]) - parseFloat(a[0]))
          .forEach(([price, {quantity, disclosed}]) => {
            const tr = document.createElement('tr');
            tr.style.cursor = 'pointer';
            tr.innerHTML = `
              <td>${price}</td>
              <td>${quantity}</td>
              <td>${disclosed}</td>
            `;
            tr.addEventListener('click', () => showOrderDetails(price, 'buy'));
            tbody.appendChild(tr);
          });
      });
  }
  function showOrderDetails(price, side) {
  // pick the right map
  const map = side === 'sell'
    ? sellOrdersByPrice
    : buyOrdersByPrice;

  const orders = map[price] || [];
  const modal      = document.getElementById('order-modal');
  const tbody      = modal.querySelector('#modal-table tbody');
  const priceSpan  = document.getElementById('modal-price');

  priceSpan.textContent = price;
  tbody.innerHTML = '';

  orders.forEach(o => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${o.user || 'N/A'}</td>
      <td>${parseFloat(o.quantity)  || 0}</td>
      <td>${parseFloat(o.disclosed) || 0}</td>
      <td>${o.original_quantity}</td>
      
    `;
    tbody.appendChild(row);
  });

  modal.style.display = 'flex';
  }

  document.getElementById('modal-close')
    .addEventListener('click', () => {
      document.getElementById('order-modal').style.display = 'none';
    });

  let sellOrdersByPrice = {};
  function updateSellOrders() {
    fetch('/orderbook/get_sell_orders/')
      .then(r => r.json())
      .then(data => {
        const tbody = document.querySelector('#sell-orders tbody');
        tbody.innerHTML = '';
        sellOrdersByPrice = {};

        const grouped = {};
        data.sell_orders
          .filter(o => !o.is_ioc)
          .forEach(o => {
            const price     = parseFloat(o.price).toFixed(2);
            const qty       = parseFloat(o.quantity)  || 0;
            const disclosed = parseFloat(o.disclosed) || 0;

            if (!grouped[price]) grouped[price] = { quantity: 0, disclosed: 0 };
            grouped[price].quantity  += qty;
            grouped[price].disclosed += disclosed;

            if (!sellOrdersByPrice[price]) sellOrdersByPrice[price] = [];
            sellOrdersByPrice[price].push(o);
          });

        Object.entries(grouped)
          .sort((a, b) => parseFloat(a[0]) - parseFloat(b[0]))
          .forEach(([price, { quantity, disclosed }]) => {
            const tr = document.createElement('tr');
            tr.style.cursor = 'pointer';
            tr.innerHTML = `
              <td>${price}</td>
              <td>${quantity}</td>
              <td>${disclosed}</td>
            `;
            tr.addEventListener('click', () => showOrderDetails(price, 'sell'));
            tbody.appendChild(tr);
          });
      })
      .catch(console.error);
  }

  function updateRecentTrades() {
    fetch('/orderbook/get_recent_trades/')
      .then(response => response.json())
      .then(data => {
        const tableBody = document.querySelector('#trades tbody');
        tableBody.innerHTML = '';
        data.trades.forEach(trade => {
          const row = `
            <tr>
              <td>${trade.buyer}</td>
              <td>${trade.seller}</td>
              <td>${trade.price}</td>
              <td>${trade.quantity}</td>
              <td>${trade.timestamp}</td>
            </tr>`;
          tableBody.innerHTML += row;
        });
      })
      .catch(error => console.error('Error fetching Recent Trades:', error));
  }

  document.addEventListener('DOMContentLoaded', function (){
    updateBuyOrders();
    updateSellOrders();
    updateRecentTrades();
    updateBestBid();
    updateBestAsk();
  });

  const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
  const socket = new WebSocket(`${ws_scheme}://${window.location.host}/ws/orderbook/`);

  socket.onopen = () => {
    console.log("WebSocket connection established");
  };

  socket.onmessage = (event) => {
    const raw = JSON.parse(event.data);
    const data = raw.data || raw;

    const statusEl = document.getElementById("status");
    if (statusEl) statusEl.innerText = "Live";

    if (data.best_bid) {
      document.getElementById("best-bid").innerText = `Price: ${data.best_bid.price} | Quantity: ${data.best_bid.disclosed}`;
    }

    if (data.best_ask) {
      document.getElementById("best-ask").innerText = `Price: ${data.best_ask.price} | Quantity: ${data.best_ask.disclosed}`;
    }

    if (data.buy_orders) {
      const buyOrdersTable = document.querySelector("#buy-orders tbody");
      buyOrdersTable.innerHTML = "";
      data.buy_orders.forEach(order => {
        buyOrdersTable.innerHTML += `<tr><td>${order.price}</td><td>${order.disclosed}</td></tr>`;
      });
    }

    if (data.sell_orders) {
      const sellOrdersTable = document.querySelector("#sell-orders tbody");
      sellOrdersTable.innerHTML = "";
      data.sell_orders.forEach(order => {
        sellOrdersTable.innerHTML += `<tr><td>${order.price}</td><td>${order.disclosed}</td></tr>`;
      });
    }

    if (data.trades) {
      const tradesTable = document.querySelector("#trades tbody");
      tradesTable.innerHTML = "";
      data.trades.forEach(trade => {
        tradesTable.innerHTML += `
          <tr>
            <td>${trade.buyer}</td>
            <td>${trade.seller}</td>
            <td>${trade.price}</td>
            <td>${trade.quantity}</td>
            <td>${trade.timestamp || '-'}</td>
          </tr>`;
      });
    }
  };

  socket.onerror = (error) => {
    console.log("WebSocket Error: ", error);
  };

  socket.onclose = (event) => {
    console.log("WebSocket connection closed: ", event);
    const statusEl = document.getElementById("status");
    if (statusEl) statusEl.innerText = "Disconnected";
  };
</script>
{% endblock %}
